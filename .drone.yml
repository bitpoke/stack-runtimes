---
kind: pipeline
name: php-runtime-8.0

workspace:
  base: /workspace
  path: src/github.com/bitpoke/stack-runtimes

steps:
- &step
  name: setup docker
  pull: always
  image: docker.io/bitpoke/build:v0.3.0-3.g7069e76
  environment: &baseEnv
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    TEST_HOSTNAME: docker
  commands:
    - dockerize -wait unix:///workspace/docker.sock -timeout 10s
    - docker info
    - make -C php pull-$DRONE_STAGE_NAME

- <<: *step
  name: build image
  pull: default
  commands:
    - make -C php $DRONE_STAGE_NAME

- <<: *step
  name: test image
  pull: default
  commands:
    - make -C php test-$DRONE_STAGE_NAME

- <<: *step
  name: publish
  pull: default
  environment:
    <<: *baseEnv
    DOCKER_USER:
      from_secret: DOCKER_USER
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" docker.io
    - make -C php push-$DRONE_STAGE_NAME

services:
- name: docker
  image: docker:20.10.8-dind
  privileged: true
  commands:
    - /usr/local/bin/dockerd-entrypoint.sh dockerd --host "unix:///workspace/docker.sock" --storage-driver overlay2 --log-level error
---
kind: pipeline
name: php-runtime-7.4

workspace:
  base: /workspace
  path: src/github.com/bitpoke/stack-runtimes

steps:
- &step
  name: setup docker
  pull: always
  image: docker.io/bitpoke/build:v0.3.0-3.g7069e76
  environment: &baseEnv
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    TEST_HOSTNAME: docker
  commands:
    - dockerize -wait unix:///workspace/docker.sock -timeout 10s
    - docker info
    - make -C php pull-$DRONE_STAGE_NAME

- <<: *step
  name: build image
  pull: default
  commands:
    - make -C php $DRONE_STAGE_NAME

- <<: *step
  name: test image
  pull: default
  commands:
    - make -C php test-$DRONE_STAGE_NAME

- <<: *step
  name: publish
  pull: default
  environment:
    <<: *baseEnv
    DOCKER_USER:
      from_secret: DOCKER_USER
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" docker.io
    - make -C php push-$DRONE_STAGE_NAME

services:
- name: docker
  image: docker:20.10.8-dind
  privileged: true
  commands:
    - /usr/local/bin/dockerd-entrypoint.sh dockerd --host "unix:///workspace/docker.sock" --storage-driver overlay2 --log-level error

---
kind: pipeline
name: wordpress-runtime-bedrock

depends_on:
  - php-runtime-7.4

workspace:
  base: /workspace
  path: src/github.com/bitpoke/stack-runtimes

steps:
- &step
  name: setup docker
  pull: always
  image: docker.io/bitpoke/build:v0.3.0-3.g7069e76
  environment: &baseEnv
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    TEST_HOSTNAME: docker
  commands:
    - dockerize -wait unix:///workspace/docker.sock -timeout 10s
    - docker info
    - make -C wordpress pull-$DRONE_STAGE_NAME

- <<: *step
  name: build image
  pull: default
  commands:
    - make -C wordpress $DRONE_STAGE_NAME

- <<: *step
  name: test image
  pull: default
  commands:
    - make -C wordpress test-$DRONE_STAGE_NAME

- <<: *step
  name: publish
  pull: default
  environment:
    <<: *baseEnv
    DOCKER_USER:
      from_secret: DOCKER_USER
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" docker.io
    - make -C wordpress push-$DRONE_STAGE_NAME

services:
- name: docker
  image: docker:20.10.8-dind
  privileged: true
  commands:
    - /usr/local/bin/dockerd-entrypoint.sh dockerd --host "unix:///workspace/docker.sock" --storage-driver overlay2 --log-level error

---
kind: pipeline
name: wordpress-runtime-5.8

depends_on:
  - wordpress-runtime-bedrock

workspace:
  base: /workspace
  path: src/github.com/bitpoke/stack-runtimes

steps:
- &step
  name: setup docker
  pull: always
  image: docker.io/bitpoke/build:v0.3.0-3.g7069e76
  environment: &baseEnv
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    TEST_HOSTNAME: docker
  commands:
    - dockerize -wait unix:///workspace/docker.sock -timeout 10s
    - docker info
    - make -C wordpress pull-$DRONE_STAGE_NAME

- <<: *step
  name: build image
  pull: default
  commands:
    - make -C wordpress $DRONE_STAGE_NAME

- <<: *step
  name: test image
  pull: default
  commands:
    - make -C wordpress test-$DRONE_STAGE_NAME

- <<: *step
  name: publish
  pull: default
  environment:
    <<: *baseEnv
    DOCKER_USER:
      from_secret: DOCKER_USER
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" docker.io
    - make -C wordpress push-$DRONE_STAGE_NAME

services:
- name: docker
  image: docker:20.10.8-dind
  privileged: true
  commands:
    - /usr/local/bin/dockerd-entrypoint.sh dockerd --host "unix:///workspace/docker.sock" --storage-driver overlay2 --log-level error

---
kind: pipeline
name: wordpress-runtime-5.9

depends_on:
  - wordpress-runtime-bedrock

workspace:
  base: /workspace
  path: src/github.com/bitpoke/stack-runtimes

steps:
- &step
  name: setup docker
  pull: always
  image: docker.io/bitpoke/build:v0.3.0-3.g7069e76
  environment: &baseEnv
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    TEST_HOSTNAME: docker
  commands:
    - dockerize -wait unix:///workspace/docker.sock -timeout 10s
    - docker info
    - make -C wordpress pull-$DRONE_STAGE_NAME

- <<: *step
  name: build image
  pull: default
  commands:
    - make -C wordpress $DRONE_STAGE_NAME

- <<: *step
  name: test image
  pull: default
  commands:
    - make -C wordpress test-$DRONE_STAGE_NAME

- <<: *step
  name: publish
  pull: default
  environment:
    <<: *baseEnv
    DOCKER_USER:
      from_secret: DOCKER_USER
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" docker.io
    - make -C wordpress push-$DRONE_STAGE_NAME

services:
- name: docker
  image: docker:20.10.8-dind
  privileged: true
  commands:
    - /usr/local/bin/dockerd-entrypoint.sh dockerd --host "unix:///workspace/docker.sock" --storage-driver overlay2 --log-level error

